<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kona Search</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Poppins:wght@500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: dark;
        --bg: radial-gradient(circle at 30% -10%, rgba(125, 240, 255, 0.18), transparent 55%),
          linear-gradient(140deg, #14132b, #1c1d3f 55%, #3c1e67);
        --surface: rgba(24, 22, 44, 0.92);
        --surface-soft: rgba(30, 28, 55, 0.72);
        --surface-outline: rgba(255, 255, 255, 0.08);
        --accent: #7df0ff;
        --accent-soft: rgba(125, 240, 255, 0.22);
        --text-primary: #f5f7ff;
        --text-secondary: rgba(245, 247, 255, 0.7);
        --text-tertiary: rgba(245, 247, 255, 0.55);
        font-family: 'Nunito', 'Poppins', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--bg);
        color: var(--text-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 3rem 1.5rem 4rem;
      }

      .search-shell {
        width: min(880px, 100%);
        display: flex;
        flex-direction: column;
        gap: 1.75rem;
        background: rgba(18, 16, 34, 0.72);
        border-radius: 28px;
        padding: 2.5rem 3rem;
        box-shadow: 0 28px 68px rgba(6, 3, 20, 0.55);
        border: 1px solid rgba(125, 240, 255, 0.12);
        backdrop-filter: blur(26px);
      }

      .search-shell header {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .search-shell header img {
        width: 60px;
        height: 60px;
        border-radius: 18px;
        box-shadow: 0 14px 30px rgba(125, 240, 255, 0.28);
      }

      .search-shell header .titles {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
      }

      .search-shell header .titles h1 {
        margin: 0;
        font-size: 1.8rem;
        font-family: 'Poppins', sans-serif;
        letter-spacing: 0.01em;
      }

      .search-shell header .titles span {
        font-size: 0.95rem;
        color: var(--text-secondary);
      }

      .search-form {
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
      }

      .search-box {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: var(--surface);
        border-radius: 18px;
        padding: 0.65rem 0.75rem 0.65rem 1rem;
        border: 1px solid var(--surface-outline);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.02), 0 12px 28px rgba(7, 3, 18, 0.45);
      }

      .search-box svg {
        width: 20px;
        height: 20px;
        fill: var(--text-tertiary);
      }

      .search-box input {
        flex: 1;
        background: transparent;
        border: none;
        font-size: 1.05rem;
        color: var(--text-primary);
        font-family: inherit;
      }

      .search-box input:focus {
        outline: none;
      }

      .search-box button {
        border: none;
        background: var(--accent);
        color: #061119;
        padding: 0.55rem 1.35rem;
        font-size: 0.95rem;
        font-weight: 700;
        border-radius: 14px;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 14px 28px rgba(125, 240, 255, 0.28);
      }

      .search-box button:hover {
        transform: translateY(-1px);
        box-shadow: 0 16px 32px rgba(125, 240, 255, 0.32);
      }

      .search-box button:active {
        transform: translateY(1px);
      }

      .search-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .search-chips--hidden {
        display: none;
      }

      .search-chips button {
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(125, 240, 255, 0.12);
        color: var(--text-primary);
        border-radius: 999px;
        padding: 0.4rem 0.85rem;
        font-size: 0.85rem;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.2s ease;
      }

      .search-chips button:hover {
        background: rgba(125, 240, 255, 0.22);
        transform: translateY(-1px);
      }

      .search-meta {
        font-size: 0.85rem;
        color: var(--text-tertiary);
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        align-items: center;
      }

      .search-meta__badge {
        background: rgba(125, 240, 255, 0.12);
        border-radius: 999px;
        border: 1px solid rgba(125, 240, 255, 0.24);
        color: var(--accent);
        padding: 0.2rem 0.75rem;
        font-size: 0.75rem;
        letter-spacing: 0.02em;
      }

      .search-meta__suggestion {
        border: 1px solid rgba(125, 240, 255, 0.32);
        background: transparent;
        color: var(--accent);
        border-radius: 999px;
        padding: 0.25rem 0.65rem;
        font-size: 0.8rem;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.2s ease;
      }

      .search-meta__suggestion:hover {
        background: rgba(125, 240, 255, 0.12);
        transform: translateY(-1px);
      }

      .results {
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
      }

      .result-card {
        padding: 1.1rem 1.2rem;
        border-radius: 18px;
        background: var(--surface);
        border: 1px solid var(--surface-outline);
        box-shadow: 0 18px 36px rgba(7, 3, 18, 0.45);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .result-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 40px rgba(7, 3, 18, 0.5);
      }

      .result-card__host {
        display: block;
        font-size: 0.8rem;
        color: var(--text-tertiary);
        margin-bottom: 0.25rem;
        letter-spacing: 0.01em;
      }

      .result-card a {
        color: var(--accent);
        font-size: 1.1rem;
        font-weight: 700;
        text-decoration: none;
        display: inline-block;
        margin-bottom: 0.35rem;
      }

      .result-card a:hover {
        text-decoration: underline;
      }

      .result-card__snippet {
        margin: 0;
        color: var(--text-secondary);
        line-height: 1.6;
      }

      .empty-state {
        text-align: center;
        padding: 2.5rem 1.5rem;
        background: var(--surface);
        border-radius: 20px;
        border: 1px solid var(--surface-outline);
        box-shadow: 0 18px 36px rgba(7, 3, 18, 0.45);
      }

      .empty-state h2 {
        margin: 0 0 0.5rem;
        font-size: 1.3rem;
      }

      .empty-state p {
        margin: 0;
        color: var(--text-secondary);
      }

      .empty-state .suggestions {
        margin-top: 1.25rem;
        display: flex;
        gap: 0.6rem;
        flex-wrap: wrap;
        justify-content: center;
      }

      .empty-state .suggestions button {
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 0.45rem 0.95rem;
        background: rgba(125, 240, 255, 0.12);
        color: var(--text-primary);
        cursor: pointer;
      }

      mark {
        background: rgba(125, 240, 255, 0.28);
        color: inherit;
        padding: 0 0.15rem;
        border-radius: 4px;
      }

      @media (max-width: 720px) {
        body {
          padding: 2rem 1rem 3rem;
        }

        .search-shell {
          padding: 2rem 1.5rem;
          border-radius: 24px;
        }

        .search-shell header {
          flex-direction: column;
          text-align: center;
        }

        .search-shell header img {
          width: 70px;
          height: 70px;
        }

        .search-box {
          flex-direction: column;
          align-items: stretch;
          padding: 0.85rem 0.9rem;
        }

        .search-box button {
          width: 100%;
        }

        .search-chips {
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <main class="search-shell">
      <header>
        <img src="assets/konata-badge.svg" alt="Konata badge" />
        <div class="titles">
          <h1>Kona Search</h1>
          <span>Konata-approved interface, powered by Google Search.</span>
        </div>
      </header>

      <form class="search-form" id="search-form">
        <div class="search-box">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path
              d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 1 0-.71.71l.27.28v.79l4.25 4.24a1 1 0 0 0 1.42-1.42L15.5 14Zm-5 0a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9Z"
            />
          </svg>
          <input id="search-input" type="text" placeholder="Search anime, memes, culture..." autocomplete="off" />
          <button type="submit">Search</button>
        </div>
        <div class="search-chips" id="search-chips"></div>
        <div class="search-meta" id="search-meta"></div>
      </form>

      <section class="results" id="results"></section>
    </main>

    <script>
      const trendingQueries = [
        'Konata gaming setup',
        'Lucky Star dance practice',
        'Cozy slice of life anime',
        'Anime convention tips',
        'Visual novel recommendations',
        'Konata cosplay wig care'
      ];

      const searchForm = document.getElementById('search-form');
      const searchInput = document.getElementById('search-input');
      const searchMeta = document.getElementById('search-meta');
      const chipsContainer = document.getElementById('search-chips');
      const resultsContainer = document.getElementById('results');

      const params = new URLSearchParams(window.location.search);
      const initialQuery = params.get('q') ? params.get('q').trim() : '';
      if (initialQuery) {
        searchInput.value = initialQuery;
      }

      let latestSearchToken = 0;

      const updateTitle = (query) => {
        document.title = query ? `Kona Search – ${query}` : 'Kona Search';
      };

      const escapeRegExp = (text) => text.replace(/[.*+?^${}()|[\]\\]/g, '\$&');

      const escapeHtml = (text) =>
        text.replace(/[&<>"']/g, (character) => {
          switch (character) {
            case '&':
              return '&amp;';
            case '<':
              return '&lt;';
            case '>':
              return '&gt;';
            case '"':
              return '&quot;';
            case "'":
              return '&#39;';
            default:
              return character;
          }
        });

      const highlightTokens = (text, tokens) => {
        if (!tokens.length) return text;
        return tokens.reduce((output, token) => {
          const pattern = new RegExp(`(${escapeRegExp(token)})`, 'gi');
          return output.replace(pattern, '<mark>$1</mark>');
        }, text);
      };

      const buildSuggestionList = (candidates, currentQuery = '') => {
        const normalizedCurrent = currentQuery.trim().toLowerCase();
        const seen = new Set();
        const output = [];

        (candidates || []).forEach((candidate) => {
          const text = typeof candidate === 'string' ? candidate.trim() : '';
          if (!text) {
            return;
          }

          const key = text.toLowerCase();
          if (key === normalizedCurrent || seen.has(key)) {
            return;
          }

          seen.add(key);
          output.push(text);
        });

        return output;
      };

      const createBadge = () => {
        const badge = document.createElement('span');
        badge.className = 'search-meta__badge';
        badge.textContent = 'Powered by Google Search';
        return badge;
      };

      const renderSuggestionChips = (suggestions) => {
        chipsContainer.innerHTML = '';
        const entries = Array.isArray(suggestions) ? suggestions : [];

        if (!entries.length) {
          chipsContainer.classList.add('search-chips--hidden');
          return;
        }

        chipsContainer.classList.remove('search-chips--hidden');

        entries.slice(0, 8).forEach((suggestion) => {
          const text = typeof suggestion === 'string' ? suggestion.trim() : '';
          if (!text) {
            return;
          }

          const button = document.createElement('button');
          button.type = 'button';
          button.textContent = text;
          button.addEventListener('click', () => {
            searchInput.value = text;
            submitQuery(text);
          });
          chipsContainer.appendChild(button);
        });
      };

      const renderStateCard = ({ heading, message, highlight = null, suggestions = [] }) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'empty-state';

        if (heading) {
          const headingEl = document.createElement('h2');
          headingEl.textContent = heading;
          wrapper.appendChild(headingEl);
        }

        if (message) {
          const paragraph = document.createElement('p');
          if (highlight) {
            const template = message.includes('%highlight%') ? message : `${message} %highlight%`;
            const escapedTemplate = escapeHtml(template);
            const safeHighlight = `<mark>${escapeHtml(highlight)}</mark>`;
            paragraph.innerHTML = escapedTemplate.replace('%highlight%', safeHighlight);
          } else {
            paragraph.textContent = message;
          }
          wrapper.appendChild(paragraph);
        }

        if (Array.isArray(suggestions) && suggestions.length) {
          const suggestionList = document.createElement('div');
          suggestionList.className = 'suggestions';
          suggestions.slice(0, 4).forEach((suggestion) => {
            const text = typeof suggestion === 'string' ? suggestion.trim() : '';
            if (!text) {
              return;
            }
            const button = document.createElement('button');
            button.type = 'button';
            button.textContent = text;
            button.addEventListener('click', () => {
              searchInput.value = text;
              submitQuery(text);
            });
            suggestionList.appendChild(button);
          });
          wrapper.appendChild(suggestionList);
        }

        resultsContainer.innerHTML = '';
        resultsContainer.appendChild(wrapper);
      };

      const appendStatsDetails = (container, info) => {
        if (!info) {
          return;
        }

        const { formattedEstimatedResults, searchTimeInSeconds, statsText } = info;

        if (formattedEstimatedResults) {
          const detail = document.createElement('span');
          let text = `About ${formattedEstimatedResults} results`;
          if (typeof searchTimeInSeconds === 'number' && Number.isFinite(searchTimeInSeconds)) {
            text += ` (${searchTimeInSeconds.toFixed(2)} seconds)`;
          }
          detail.textContent = `${text}.`;
          container.appendChild(detail);
          return;
        }

        if (statsText) {
          const detail = document.createElement('span');
          detail.textContent = statsText;
          container.appendChild(detail);
        }
      };

      const appendDidYouMean = (container, suggestion) => {
        if (!suggestion?.suggestion) {
          return;
        }

        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'search-meta__suggestion';
        button.innerHTML = `Did you mean <strong>${escapeHtml(suggestion.suggestion)}</strong>?`;
        button.addEventListener('click', () => {
          const candidate = suggestion.query?.trim() || suggestion.suggestion;
          searchInput.value = candidate;
          submitQuery(candidate);
        });
        container.appendChild(button);
      };

      const renderMetaIdle = () => {
        searchMeta.innerHTML = '';
        const message = document.createElement('span');
        message.textContent = 'Search the entire web with Google.';
        searchMeta.appendChild(message);
        searchMeta.appendChild(createBadge());
      };

      const renderMetaLoading = () => {
        searchMeta.innerHTML = '';
        const message = document.createElement('span');
        message.textContent = 'Searching Google…';
        searchMeta.appendChild(message);
        searchMeta.appendChild(createBadge());
      };

      const renderMetaError = () => {
        searchMeta.innerHTML = '';
        const message = document.createElement('span');
        message.textContent = 'Unable to reach Google Search right now.';
        searchMeta.appendChild(message);
        searchMeta.appendChild(createBadge());
      };

      const renderMetaNoResults = (query, info, didYouMean) => {
        searchMeta.innerHTML = '';
        const message = document.createElement('span');
        message.textContent = `No Google results for “${query}”.`;
        searchMeta.appendChild(message);
        appendStatsDetails(searchMeta, info);
        searchMeta.appendChild(createBadge());
        appendDidYouMean(searchMeta, didYouMean);
      };

      const renderMetaResults = (count, info, didYouMean) => {
        searchMeta.innerHTML = '';
        const message = document.createElement('span');
        message.textContent = `Showing top ${count} Google result${count === 1 ? '' : 's'}.`;
        searchMeta.appendChild(message);
        appendStatsDetails(searchMeta, info);
        searchMeta.appendChild(createBadge());
        appendDidYouMean(searchMeta, didYouMean);
      };

      const renderInitialState = () => {
        renderStateCard({
          heading: 'Search with Google',
          message: 'Type a query to explore the web with Google or tap a Konata-approved suggestion to get started.',
          suggestions: trendingQueries
        });
      };

      const renderLoadingState = (query) => {
        renderStateCard({
          heading: 'Searching Google…',
          message: 'Looking up %highlight% right now.',
          highlight: query
        });
      };

      const renderErrorState = (suggestions) => {
        renderStateCard({
          heading: 'Unable to reach Google',
          message: 'We couldn’t connect to Google Search. Please check your connection and try again.',
          suggestions
        });
      };

      const renderNoResultsState = (query, suggestions) => {
        renderStateCard({
          heading: 'No Google results yet',
          message: 'Google Search didn’t return matches for %highlight%. Try a different keyword or explore a suggested search.',
          highlight: query,
          suggestions
        });
      };

      const deriveDisplayLink = (entry) => {
        if (entry.displayLink) {
          return entry.displayLink;
        }
        if (entry.url) {
          try {
            return new URL(entry.url).hostname;
          } catch (_error) {
            return entry.url;
          }
        }
        return '';
      };

      const renderResultCards = (entries, terms) => {
        resultsContainer.innerHTML = '';
        entries.forEach((entry) => {
          const card = document.createElement('article');
          card.className = 'result-card';

          const host = deriveDisplayLink(entry);
          if (host) {
            const hostEl = document.createElement('span');
            hostEl.className = 'result-card__host';
            hostEl.textContent = host;
            card.appendChild(hostEl);
          }

          if (entry.url && entry.title) {
            const link = document.createElement('a');
            link.href = entry.url;
            link.target = '_blank';
            link.rel = 'noopener';
            link.innerHTML = highlightTokens(escapeHtml(entry.title), terms);
            card.appendChild(link);
          }

          if (entry.snippet) {
            const description = document.createElement('p');
            description.className = 'result-card__snippet';
            description.innerHTML = highlightTokens(escapeHtml(entry.snippet), terms);
            card.appendChild(description);
          }

          resultsContainer.appendChild(card);
        });
      };

      async function runSearch(rawValue) {
        const query = typeof rawValue === 'string' ? rawValue.trim() : '';
        latestSearchToken += 1;
        const token = latestSearchToken;

        updateTitle(query);

        if (!query) {
          const suggestions = buildSuggestionList(trendingQueries);
          renderSuggestionChips(suggestions);
          renderInitialState();
          renderMetaIdle();
          return;
        }

        const tokens = query
          .toLowerCase()
          .split(/\s+/)
          .filter(Boolean);

        renderSuggestionChips([]);
        renderMetaLoading();
        renderLoadingState(query);

        if (!window.kona?.searchGoogle) {
          if (token !== latestSearchToken) {
            return;
          }
          const fallbackSuggestions = buildSuggestionList(trendingQueries, query);
          renderSuggestionChips(fallbackSuggestions);
          renderMetaError();
          renderErrorState(fallbackSuggestions);
          return;
        }

        let response;
        try {
          response = await window.kona.searchGoogle(query);
        } catch (error) {
          console.error('Kona Search failed to reach Google Search', error);
          if (token !== latestSearchToken) {
            return;
          }
          const fallbackSuggestions = buildSuggestionList(trendingQueries, query);
          renderSuggestionChips(fallbackSuggestions);
          renderMetaError();
          renderErrorState(fallbackSuggestions);
          return;
        }

        if (token !== latestSearchToken) {
          return;
        }

        if (!response?.ok) {
          console.error('Kona Search received an error response from Google bridge', response?.error);
          const fallbackSuggestions = buildSuggestionList(trendingQueries, query);
          renderSuggestionChips(fallbackSuggestions);
          renderMetaError();
          renderErrorState(fallbackSuggestions);
          return;
        }

        const payload = response.payload || {};
        const results = Array.isArray(payload.results) ? payload.results : [];
        const info = payload.info || null;
        const didYouMean = payload.didYouMean || null;
        const related = buildSuggestionList(payload.relatedQueries || [], query);
        const fallbackSuggestions = related.length ? related : buildSuggestionList(trendingQueries, query);

        if (!results.length) {
          renderSuggestionChips(fallbackSuggestions);
          renderNoResultsState(query, fallbackSuggestions);
          renderMetaNoResults(query, info, didYouMean);
          return;
        }

        renderSuggestionChips(fallbackSuggestions);
        renderResultCards(results, tokens);
        renderMetaResults(results.length, info, didYouMean);
      }

      function submitQuery(value) {
        const query = typeof value === 'string' ? value.trim() : '';
        const nextSearch = query ? `?q=${encodeURIComponent(query)}` : '';
        const target = nextSearch || window.location.pathname;

        if (nextSearch === window.location.search || (!nextSearch && !window.location.search)) {
          searchInput.value = query;
          runSearch(query);
          return;
        }

        history.pushState({}, '', target);
        searchInput.value = query;
        runSearch(query);
      }

      searchForm.addEventListener('submit', (event) => {
        event.preventDefault();
        submitQuery(searchInput.value);
      });

      window.addEventListener('popstate', () => {
        const current = new URLSearchParams(window.location.search).get('q') || '';
        searchInput.value = current;
        runSearch(current);
      });

      runSearch(initialQuery);
    </script>
  </body>
</html>
